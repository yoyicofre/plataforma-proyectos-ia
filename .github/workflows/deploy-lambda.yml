name: Deploy Lambda

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "prod"
        type: choice
        options:
          - dev
          - prod
      function_name:
        description: "Lambda function name"
        required: true
        default: "plataforma-ia-api"
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "lambda_handler.py"
      - "scripts/package_lambda.ps1"
      - "scripts/package_lambda_layer.ps1"
      - "scripts/deploy_lambda.ps1"
      - ".github/workflows/deploy-lambda.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Package Lambda Layer
        shell: pwsh
        run: ./scripts/package_lambda_layer.ps1

      - name: Package Lambda ZIP
        shell: pwsh
        run: ./scripts/package_lambda.ps1

      - name: Deploy Lambda
        shell: pwsh
        env:
          APP_NAME: ${{ vars.APP_NAME || 'Project Template' }}
          ENVIRONMENT: ${{ github.event.inputs.environment || vars.ENVIRONMENT || 'prod' }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL || 'INFO' }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ vars.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ALGORITHM: ${{ vars.JWT_ALGORITHM || 'HS256' }}
          JWT_ISSUER: ${{ vars.JWT_ISSUER || 'plataforma-ia' }}
          JWT_AUDIENCE: ${{ vars.JWT_AUDIENCE || 'plataforma-ia-api' }}
          JWT_EXP_MINUTES: ${{ vars.JWT_EXP_MINUTES || '480' }}
          DEV_BOOTSTRAP_KEY: ${{ secrets.DEV_BOOTSTRAP_KEY }}
          PORTAL_ACCESS_KEY: ${{ secrets.PORTAL_ACCESS_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL_TEXT: ${{ vars.OPENAI_MODEL_TEXT || 'gpt-5.2' }}
          OPENAI_MODEL_IMAGE: ${{ vars.OPENAI_MODEL_IMAGE || 'gpt-image-1' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL_TEXT: ${{ vars.GEMINI_MODEL_TEXT || 'gemini-3-pro-preview' }}
          GEMINI_MODEL_IMAGE: ${{ vars.GEMINI_MODEL_IMAGE || 'gemini-3-pro-image-preview' }}
          OPENAI_TEXT_INPUT_COST_PER_1K: ${{ vars.OPENAI_TEXT_INPUT_COST_PER_1K || '0' }}
          OPENAI_TEXT_OUTPUT_COST_PER_1K: ${{ vars.OPENAI_TEXT_OUTPUT_COST_PER_1K || '0' }}
          GEMINI_TEXT_INPUT_COST_PER_1K: ${{ vars.GEMINI_TEXT_INPUT_COST_PER_1K || '0' }}
          GEMINI_TEXT_OUTPUT_COST_PER_1K: ${{ vars.GEMINI_TEXT_OUTPUT_COST_PER_1K || '0' }}
          OPENAI_IMAGE_COST_PER_IMAGE: ${{ vars.OPENAI_IMAGE_COST_PER_IMAGE || '0' }}
          GEMINI_IMAGE_COST_PER_IMAGE: ${{ vars.GEMINI_IMAGE_COST_PER_IMAGE || '0' }}
        run: |
          $targetFunction = "${{ github.event.inputs.function_name }}"
          if (-not $targetFunction) {
            $targetFunction = "plataforma-ia-api"
          }
          $keepLayerVersions = "${{ vars.LAMBDA_LAYER_VERSIONS_TO_KEEP || '5' }}"
          ./scripts/deploy_lambda.ps1 -FunctionName $targetFunction -Region "${{ vars.AWS_REGION || 'us-east-1' }}" -LayerVersionsToKeep $keepLayerVersions
